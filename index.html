<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Budget ¬∑ VND</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0f14;
  --surface:#161921;
  --surface2:#1e2330;
  --surface3:#252c3d;
  --border:#2a3347;
  --accent:#f5a623;
  --accent2:#e8845a;
  --green:#4ecca3;
  --red:#ff6b7a;
  --text:#eef0f6;
  --text2:#8892a4;
  --text3:#505a70;
  --radius:16px;
  --radius-sm:10px;
}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;max-width:430px;margin:0 auto;position:relative;overflow-x:hidden}
body::before{content:'';position:fixed;top:-200px;right:-100px;width:400px;height:400px;background:radial-gradient(circle,rgba(245,166,35,.07) 0%,transparent 70%);pointer-events:none;z-index:0}

/* LAYOUT */
#app{display:flex;flex-direction:column;min-height:100dvh;position:relative;z-index:1}
.page{flex:1;overflow-y:auto;padding:0 0 90px;display:none}
.page.active{display:block}
nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(22,25,33,.95);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;z-index:100;padding:8px 0 env(safe-area-inset-bottom,8px)}
nav button{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;background:none;border:none;color:var(--text3);font-family:'Sora',sans-serif;font-size:10px;font-weight:500;cursor:pointer;padding:6px 0;transition:.2s;letter-spacing:.3px}
nav button svg{width:22px;height:22px;transition:.2s}
nav button.active{color:var(--accent)}
nav button.active svg{filter:drop-shadow(0 0 6px rgba(245,166,35,.5))}

/* FAB */
.fab{position:fixed;bottom:74px;right:max(16px, calc(50% - 199px));z-index:101;width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff;font-size:26px;cursor:pointer;box-shadow:0 4px 24px rgba(245,166,35,.4);transition:.2s;display:flex;align-items:center;justify-content:center}
.fab:hover{transform:scale(1.08);box-shadow:0 6px 32px rgba(245,166,35,.5)}
.fab:active{transform:scale(.95)}

/* HEADER */
.page-header{padding:52px 20px 20px;position:sticky;top:0;background:var(--bg);z-index:10}
.page-header h1{font-size:22px;font-weight:700;letter-spacing:-.3px}
.page-header p{color:var(--text2);font-size:13px;margin-top:2px}

/* HOME */
.home-hero{margin:16px 20px 0;background:linear-gradient(135deg,var(--surface2),var(--surface));border:1px solid var(--border);border-radius:24px;padding:28px 24px;position:relative;overflow:hidden}
.home-hero::before{content:'';position:absolute;top:-30px;right:-30px;width:150px;height:150px;background:radial-gradient(circle,rgba(245,166,35,.12),transparent 70%)}
.hero-label{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:1px;text-transform:uppercase}
.hero-amount{font-family:'JetBrains Mono',monospace;font-size:38px;font-weight:500;letter-spacing:-1px;margin:6px 0;line-height:1}
.hero-amount.positive{color:var(--green)}
.hero-amount.negative{color:var(--red)}
.hero-sub{display:flex;gap:20px;margin-top:18px;padding-top:16px;border-top:1px solid var(--border)}
.hero-sub-item{flex:1}
.hero-sub-item .lbl{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.hero-sub-item .val{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:500;margin-top:3px}
.hero-sub-item .val.pos{color:var(--green)}
.hero-sub-item .val.neg{color:var(--red)}

.section-title{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:1px;text-transform:uppercase;padding:24px 20px 10px}
.quick-cats{display:flex;gap:10px;padding:0 20px;overflow-x:auto;scrollbar-width:none}
.quick-cats::-webkit-scrollbar{display:none}
.quick-cat{flex:0 0 auto;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:.15s;font-size:13px;font-weight:500}
.quick-cat:hover{border-color:var(--accent);background:var(--surface2)}
.quick-cat .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

.recent-ops{padding:0 20px;display:flex;flex-direction:column;gap:8px}
.op-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:.15s}
.op-card:hover{border-color:var(--border);background:var(--surface2)}
.op-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.op-info{flex:1;min-width:0}
.op-name{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.op-meta{font-size:11px;color:var(--text3);margin-top:2px}
.op-amount{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:500;flex-shrink:0}
.op-amount.expense{color:var(--red)}
.op-amount.income{color:var(--green)}

/* HISTORY */
.history-group{padding:0 20px;margin-bottom:4px}
.history-date{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;padding:20px 0 8px;display:flex;justify-content:space-between;align-items:center}
.history-date .date-total{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:500}

/* REPORTS */
.report-section{padding:0 20px;margin-bottom:20px}
.report-bar{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.report-bar-title{font-size:12px;color:var(--text2);margin-bottom:16px;font-weight:500}
.bar-item{margin-bottom:12px}
.bar-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:5px}
.bar-label .cat-name{font-weight:500}
.bar-label .cat-val{font-family:'JetBrains Mono',monospace;color:var(--text2)}
.bar-track{height:6px;background:var(--surface3);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px;transition:width .4s ease}

.report-summary{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.summary-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px}
.summary-card .s-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:600}
.summary-card .s-val{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:500;margin-top:6px}
.summary-card .s-val.red{color:var(--red)}
.summary-card .s-val.green{color:var(--green)}

/* SETTINGS */
.settings-section{padding:0 20px;margin-bottom:24px}
.settings-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border);cursor:pointer;transition:.15s;gap:12px}
.settings-row:last-child{border-bottom:none}
.settings-row:hover{background:var(--surface2)}
.settings-row .row-label{font-size:14px;font-weight:500}
.settings-row .row-sub{font-size:11px;color:var(--text3);margin-top:2px}
.settings-row .row-val{font-size:13px;color:var(--accent);font-family:'JetBrains Mono',monospace;flex-shrink:0}

.cats-list{display:flex;flex-direction:column;gap:8px}
.cat-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;display:flex;align-items:center;gap:12px}
.cat-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.cat-name-text{flex:1;font-size:14px;font-weight:500}
.cat-del{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;border-radius:6px;transition:.15s;display:flex}
.cat-del:hover{color:var(--red);background:rgba(255,107,122,.1)}

/* MODALS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:200;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:.25s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border-radius:24px 24px 0 0;width:100%;max-width:430px;margin:0 auto;padding:24px 20px calc(env(safe-area-inset-bottom,0px) + 24px);transform:translateY(100%);transition:.3s cubic-bezier(.32,1,.35,1);max-height:90dvh;overflow-y:auto}
.overlay.open .modal{transform:translateY(0)}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px}
.modal-title{font-size:18px;font-weight:700;margin-bottom:20px;letter-spacing:-.2px}

/* FORM */
.form-group{margin-bottom:16px}
.form-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;display:block}
.form-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:13px 16px;color:var(--text);font-family:'Sora',sans-serif;font-size:15px;outline:none;transition:.2s}
.form-input:focus{border-color:var(--accent);background:var(--surface3)}
.form-input::placeholder{color:var(--text3)}
.amount-input-wrap{position:relative}
.amount-input-wrap .currency{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--text3);font-weight:600;pointer-events:none}
.amount-suggestions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.suggestion{background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:12px;font-family:'JetBrains Mono',monospace;cursor:pointer;color:var(--text2);transition:.15s}
.suggestion:hover{border-color:var(--accent);color:var(--accent)}

.type-toggle{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.type-btn{padding:11px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-family:'Sora',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:.2s}
.type-btn.active.expense{background:rgba(255,107,122,.15);border-color:var(--red);color:var(--red)}
.type-btn.active.income{background:rgba(78,204,163,.15);border-color:var(--green);color:var(--green)}

.cats-picker{display:flex;flex-wrap:wrap;gap:8px}
.cat-pick{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);cursor:pointer;font-size:12px;font-weight:500;transition:.15s}
.cat-pick.selected{border-color:var(--accent);background:rgba(245,166,35,.1);color:var(--accent)}
.cat-pick .dot{width:8px;height:8px;border-radius:50%}

.btn{width:100%;padding:14px;border-radius:var(--radius-sm);border:none;font-family:'Sora',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:.2s;letter-spacing:.2px}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 4px 20px rgba(245,166,35,.3)}
.btn-primary:hover{box-shadow:0 6px 28px rgba(245,166,35,.4)}
.btn-primary:active{transform:scale(.98)}
.btn-danger{background:rgba(255,107,122,.15);color:var(--red);border:1px solid rgba(255,107,122,.3)}
.btn-ghost{background:var(--surface2);color:var(--text2);border:1px solid var(--border);margin-top:8px}

.color-picker{display:flex;gap:8px;flex-wrap:wrap}
.color-opt{width:32px;height:32px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:.15s}
.color-opt.selected{border-color:var(--text)}

.emoji-wrap{position:relative;display:inline-flex}
.emoji-del-x{position:absolute;top:-6px;right:-6px;width:16px;height:16px;background:var(--red);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;cursor:pointer;font-weight:700;line-height:1;z-index:5;border:1.5px solid var(--bg)}

.week-day-picker{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.wd-btn{padding:8px 4px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-size:11px;font-weight:600;cursor:pointer;transition:.15s;text-align:center}
.wd-btn.active{background:rgba(245,166,35,.15);border-color:var(--accent);color:var(--accent)}

.budget-period{display:flex;justify-content:flex-end;gap:6px;padding:0 20px 0}
.period-btn{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--surface);color:var(--text3);cursor:pointer;transition:.15s;font-family:'Sora',sans-serif}
.period-btn.active{background:var(--accent);border-color:var(--accent);color:#000}

.empty{text-align:center;padding:60px 20px;color:var(--text3)}
.empty svg{width:48px;height:48px;opacity:.3;margin-bottom:12px}
.empty p{font-size:14px}

.confirm-btns{display:flex;flex-direction:column;gap:8px;margin-top:8px}
</style>
</head>
<body>
<div id="app">
  <!-- PAGES -->
  <div class="page active" id="page-home">
    <div class="page-header">
      <h1 id="greeting">–ü—Ä–∏–≤–µ—Ç üëã</h1>
      <p id="today-date"></p>
    </div>
    <!-- hero -->
    <div class="home-hero">
      <div class="hero-label">–û–°–¢–ê–õ–û–°–¨ –ù–ê –°–ï–ì–û–î–ù–Ø</div>
      <div class="hero-amount" id="hero-today">0 ‚Ç´</div>
      <div class="hero-sub">
        <div class="hero-sub-item">
          <div class="lbl">–ù–ê –ù–ï–î–ï–õ–Æ</div>
          <div class="val" id="hero-week">0 ‚Ç´</div>
        </div>
        <div class="hero-sub-item">
          <div class="lbl">–î–ù–ï–í–ù–û–ô –õ–ò–ú–ò–¢</div>
          <div class="val" id="hero-daily">0 ‚Ç´</div>
        </div>
      </div>
    </div>
    <!-- quick categories -->
    <div class="section-title">–ö–ê–¢–ï–ì–û–†–ò–ò</div>
    <div class="quick-cats" id="quick-cats"></div>
    <!-- recent -->
    <div class="section-title">–ü–û–°–õ–ï–î–ù–ò–ï –û–ü–ï–†–ê–¶–ò–ò</div>
    <div class="recent-ops" id="recent-ops"></div>
  </div>

  <div class="page" id="page-history">
    <div class="page-header" style="padding-bottom:12px">
      <h1>–ò—Å—Ç–æ—Ä–∏—è</h1>
    </div>
    <div style="padding:0 20px 10px;display:flex;gap:6px;justify-content:flex-end">
      <button class="period-btn active" data-period="week" onclick="setHistPeriod('week')">–ù–µ–¥–µ–ª—è</button>
      <button class="period-btn" data-period="month" onclick="setHistPeriod('month')">–ú–µ—Å—è—Ü</button>
      <button class="period-btn" data-period="all" onclick="setHistPeriod('all')">–í—Å—ë</button>
    </div>
    <div id="history-container" style="padding:0 20px"></div>
  </div>

  <div class="page" id="page-reports">
    <div class="page-header" style="padding-bottom:12px">
      <h1>–û—Ç—á—ë—Ç—ã</h1>
    </div>
    <div style="padding:0 20px 10px;display:flex;gap:6px;justify-content:flex-end">
      <button class="period-btn active" data-period="week" onclick="setRepPeriod('week')">–ù–µ–¥–µ–ª—è</button>
      <button class="period-btn" data-period="month" onclick="setRepPeriod('month')">–ú–µ—Å—è—Ü</button>
      <button class="period-btn" data-period="all" onclick="setRepPeriod('all')">–í—Å—ë</button>
    </div>
    <div id="reports-container" style="padding:0 20px"></div>
  </div>

  <div class="page" id="page-settings">
    <div class="page-header"><h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1></div>
    <div class="settings-section">
      <div class="section-title" style="padding:0 0 10px">–ë–Æ–î–ñ–ï–¢</div>
      <div class="settings-card">
        <div class="settings-row" onclick="openBudgetModal()">
          <div>
            <div class="row-label">–ù–µ–¥–µ–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç</div>
            <div class="row-sub">–¢–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã</div>
          </div>
          <div class="row-val" id="setting-budget">0 ‚Ç´</div>
        </div>
        <div class="settings-row" onclick="openWeekdayModal()">
          <div>
            <div class="row-label">–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏</div>
            <div class="row-sub">–î–µ–Ω—å —Å–±—Ä–æ—Å–∞ –±—é–¥–∂–µ—Ç–∞</div>
          </div>
          <div class="row-val" id="setting-weekday">–ß—Ç</div>
        </div>
      </div>
    </div>
    <div class="settings-section">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0 0 10px">
        <div class="section-title" style="padding:0">–ö–ê–¢–ï–ì–û–†–ò–ò</div>
        <button onclick="openAddCatModal()" style="background:var(--accent);border:none;color:#000;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Sora',sans-serif">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="cats-list" id="cats-list"></div>
    </div>
  </div>

  <!-- NAV -->
  <nav>
    <button class="active" onclick="goTo('home')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      –ì–ª–∞–≤–Ω–∞—è
    </button>
    <button onclick="goTo('history')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      –ò—Å—Ç–æ—Ä–∏—è
    </button>
    <button onclick="goTo('reports')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      –û—Ç—á—ë—Ç—ã
    </button>
    <button onclick="goTo('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    </button>
  </nav>
  <button class="fab" onclick="openAddOpModal()">+</button>
</div>

<!-- MODAL: ADD/EDIT OPERATION -->
<div class="overlay" id="overlay-op" onclick="closeOverlay('overlay-op',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="op-modal-title">–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</div>
    <div class="form-group">
      <label class="form-label">–¢–∏–ø</label>
      <div class="type-toggle">
        <button class="type-btn expense active" id="type-expense" onclick="selectType('expense')">‚Äî –†–∞—Å—Ö–æ–¥</button>
        <button class="type-btn income" id="type-income" onclick="selectType('income')">+ –î–æ—Ö–æ–¥</button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">–°—É–º–º–∞ (VND)</label>
      <div class="amount-input-wrap">
        <input class="form-input" id="op-amount" type="text" inputmode="numeric" placeholder="0" oninput="onAmountInput(this)"/>
        <span class="currency">‚Ç´</span>
      </div>
      <div class="amount-suggestions" id="amount-suggestions"></div>
    </div>
    <div class="form-group">
      <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <div class="cats-picker" id="cats-picker"></div>
    </div>
    <div class="form-group" id="op-date-group" style="display:none">
      <label class="form-label">–î–∞—Ç–∞</label>
      <input class="form-input" id="op-date" type="date"/>
    </div>
    <div class="form-group">
      <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <input class="form-input" id="op-comment" type="text" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"/>
    </div>
    <button class="btn btn-primary" id="op-save-btn" onclick="saveOperation()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn btn-ghost" id="op-del-btn" onclick="deleteCurrentOp()" style="display:none;margin-top:8px">–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
  </div>
</div>

<!-- MODAL: BUDGET -->
<div class="overlay" id="overlay-budget" onclick="closeOverlay('overlay-budget',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–µ–¥–µ–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç</div>
    <div class="form-group">
      <label class="form-label">–°—É–º–º–∞ (VND)</label>
      <div class="amount-input-wrap">
        <input class="form-input" id="budget-input" type="text" inputmode="numeric" placeholder="0" oninput="onAmountInput(this)"/>
        <span class="currency">‚Ç´</span>
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveBudget()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- MODAL: WEEKDAY -->
<div class="overlay" id="overlay-weekday" onclick="closeOverlay('overlay-weekday',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏</div>
    <div class="form-group">
      <div class="week-day-picker" id="weekday-picker"></div>
    </div>
    <button class="btn btn-primary" onclick="saveWeekday()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- MODAL: ADD CATEGORY -->
<div class="overlay" id="overlay-cat" onclick="closeOverlay('overlay-cat',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
    <div class="form-group">
      <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input class="form-input" id="cat-name-input" type="text" placeholder="–ï–¥–∞, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç..."/>
    </div>
    <div class="form-group">
      <label class="form-label">–¶–≤–µ—Ç</label>
      <div class="color-picker" id="color-picker"></div>
    </div>
    <div class="form-group">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <label class="form-label" style="margin-bottom:0">–ò–∫–æ–Ω–∫–∞</label>
        <button id="icon-edit-toggle" onclick="toggleIconEditMode()" style="background:none;border:none;color:var(--text3);font-size:11px;font-weight:600;font-family:'Sora',sans-serif;cursor:pointer;letter-spacing:.5px;padding:4px 8px;border-radius:6px;transition:.15s">–ò–∑–º–µ–Ω–∏—Ç—å</button>
      </div>
      <div class="cats-picker" id="icon-picker" style="gap:6px;position:relative"></div>
    </div>
    <button class="btn btn-primary" onclick="saveCategory()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
</div>

<!-- MODAL: CONFIRM DELETE -->
<div class="overlay" id="overlay-confirm" onclick="closeOverlay('overlay-confirm',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="confirm-title">–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?</div>
    <p style="color:var(--text2);font-size:14px;line-height:1.6;margin-bottom:20px" id="confirm-text"></p>
    <div class="confirm-btns">
      <button class="btn btn-danger" id="confirm-ok-btn">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn btn-ghost" onclick="closeModal('overlay-confirm')">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COLORS = ['#f5a623','#e8845a','#ff6b7a','#4ecca3','#5b8dee','#a78bfa','#f472b6','#34d399','#fb923c','#818cf8'];
const ICONS  = ['üçú','üçï','üç∫','‚òï','üöó','üöå','üè†','üíä','üõçÔ∏è','üé¨','üí°','üì±','‚úàÔ∏è','üéÆ','üê∂','üìö','üí™','üéµ','üèãÔ∏è','üí∞'];
const DAYS   = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];

function load(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}

let operations  = load('ops',[]);
let categories  = load('cats',[
  {id:'c1',name:'–ï–¥–∞',color:'#f5a623',icon:'üçú'},
  {id:'c2',name:'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',color:'#5b8dee',icon:'üöó'},
  {id:'c3',name:'–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',color:'#a78bfa',icon:'üé¨'},
  {id:'c4',name:'–ó–¥–æ—Ä–æ–≤—å–µ',color:'#4ecca3',icon:'üíä'},
]);
let weeklyBudget = load('budget',0);
let weekStartDay = load('weekStart',4); // 4 = Thursday
let histPeriod   = 'week';
let repPeriod    = 'week';
let currentPage  = 'home';

// edit state
let editingOpId  = null;
let selectedType = 'expense';
let selectedCat  = null;
let selectedColor = COLORS[0];
let selectedIcon  = ICONS[0];
let selectedWeekday = weekStartDay;

// ‚îÄ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtVND(n){
  if(n==null||isNaN(n))return '0';
  return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
}
function parseVND(s){
  return parseInt(s.replace(/[^\d]/g,''))||0;
}
function onAmountInput(el){
  let raw = el.value.replace(/[^\d]/g,'');
  let num = parseInt(raw)||0;
  // format
  el.value = raw ? fmtVND(num) : '';
  // suggestions
  if(el.id === 'op-amount') renderSuggestions(num);
}
function renderSuggestions(num){
  const box = document.getElementById('amount-suggestions');
  if(!num){box.innerHTML='';return}
  const mults = [10,100,1000,10000];
  box.innerHTML = mults.map(m=>`<span class="suggestion" onclick="applySuggestion(${num*m})">${fmtVND(num*m)}</span>`).join('');
}
function applySuggestion(val){
  document.getElementById('op-amount').value = fmtVND(val);
  renderSuggestions(val);
}

// ‚îÄ‚îÄ‚îÄ DATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getVNNow(){
  // Vietnam = UTC+7, –≤—Å–µ–≥–¥–∞
  return new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Ho_Chi_Minh'}));
}
function dateStr(d=null){
  const vn = d || getVNNow();
  return vn.getFullYear()+'-'+String(vn.getMonth()+1).padStart(2,'0')+'-'+String(vn.getDate()).padStart(2,'0');
}
function getWeekStart(dayNum){
  const now = getVNNow();
  const dow = now.getDay();
  let diff = (dow - dayNum + 7) % 7;
  const start = new Date(now);
  start.setDate(now.getDate() - diff);
  start.setHours(0,0,0,0);
  return start;
}
function inPeriod(op, period){
  const d = new Date(op.date + 'T00:00:00');
  const today = getVNNow(); today.setHours(0,0,0,0);
  if(period==='week'){
    const ws = getWeekStart(weekStartDay);
    return d >= ws && d <= today;
  }
  if(period==='month'){
    const ms = new Date(today.getFullYear(), today.getMonth(), 1);
    return d >= ms && d <= today;
  }
  return true;
}

// ‚îÄ‚îÄ‚îÄ BUDGET CALC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function daysLeftInWeek(){
  const now = getVNNow();
  const dow = now.getDay();
  // —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏ (–≤–∫–ª—é—á–∞—è —Å–µ–≥–æ–¥–Ω—è)
  let d = (weekStartDay - dow + 7) % 7;
  return d === 0 ? 7 : d;
}
function calcBudget(){
  const todayStr = dateStr();
  const spentToday = operations
    .filter(o=>o.type==='expense' && o.date===todayStr)
    .reduce((s,o)=>s+o.amount,0);
  const spentWeek = operations
    .filter(o=>o.type==='expense' && inPeriod(o,'week'))
    .reduce((s,o)=>s+o.amount,0);
  const remWeek = weeklyBudget - spentWeek;
  const daysLeft = daysLeftInWeek();
  const daily = daysLeft > 0 ? remWeek / daysLeft : 0;
  return {
    daily,
    remToday: daily - spentToday,
    remWeek,
    spentToday, spentWeek
  };
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goTo(page){
  currentPage = page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelectorAll('nav button').forEach((b,i)=>{
    b.classList.toggle('active', ['home','history','reports','settings'][i]===page);
  });
  if(page==='home') renderHome();
  if(page==='history') renderHistory();
  if(page==='reports') renderReports();
  if(page==='settings') renderSettings();
}

// ‚îÄ‚îÄ‚îÄ RENDER HOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHome(){
  const h = new Date().getHours();
  const greet = h<12?'–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ ‚òÄÔ∏è':h<17?'–î–æ–±—Ä—ã–π –¥–µ–Ω—å üëã':'–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä üåô';
  document.getElementById('greeting').textContent = greet;
  document.getElementById('today-date').textContent = new Date().toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'});
  
  const {daily, remToday, remWeek} = calcBudget();
  const heroEl = document.getElementById('hero-today');
  heroEl.textContent = fmtVND(Math.abs(remToday)) + ' ‚Ç´';
  heroEl.className = 'hero-amount ' + (remToday>=0?'positive':'negative');
  if(remToday<0) heroEl.textContent = '‚àí' + heroEl.textContent;

  const wEl = document.getElementById('hero-week');
  wEl.textContent = fmtVND(Math.abs(remWeek)) + ' ‚Ç´';
  wEl.className = 'val ' + (remWeek>=0?'pos':'neg');
  if(remWeek<0) wEl.textContent = '‚àí' + wEl.textContent;

  document.getElementById('hero-daily').textContent = fmtVND(daily) + ' ‚Ç´';

  // quick cats ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —á–∞—Å—Ç–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  const usageCount = {};
  operations.forEach(o=>{ usageCount[o.category]=(usageCount[o.category]||0)+1; });
  const sortedCats = [...categories].sort((a,b)=>(usageCount[b.id]||0)-(usageCount[a.id]||0));
  const qc = document.getElementById('quick-cats');
  qc.innerHTML = sortedCats.map(c=>`
    <div class="quick-cat" onclick="openAddOpModal(null,'${c.id}')">
      <span>${c.icon}</span>
      <span>${c.name}</span>
    </div>`).join('');

  // recent 5
  const recent = [...operations].sort((a,b)=>b.id.localeCompare(a.id)).slice(0,5);
  const ro = document.getElementById('recent-ops');
  if(!recent.length){
    ro.innerHTML='<div class="empty"><p>–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p></div>';return;
  }
  ro.innerHTML = recent.map(o=>opCardHTML(o)).join('');
}

function opCardHTML(o){
  const cat = categories.find(c=>c.id===o.category)||{name:'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',icon:'üìÅ',color:'#666'};
  const sign = o.type==='expense'?'‚àí':'+';
  return `<div class="op-card" onclick="openEditOpModal('${o.id}')">
    <div class="op-icon" style="background:${cat.color}20">${cat.icon}</div>
    <div class="op-info">
      <div class="op-name">${cat.name}${o.comment?' ¬∑ '+o.comment:''}</div>
      <div class="op-meta">${formatDate(o.date)}</div>
    </div>
    <div class="op-amount ${o.type}">${sign}${fmtVND(o.amount)} ‚Ç´</div>
  </div>`;
}

function formatDate(d){
  const today = dateStr();
  const yest = dateStr(new Date(Date.now()-86400000));
  if(d===today) return '–°–µ–≥–æ–¥–Ω—è';
  if(d===yest) return '–í—á–µ—Ä–∞';
  return new Date(d+'T00:00:00').toLocaleDateString('ru-RU',{day:'numeric',month:'short'});
}

// ‚îÄ‚îÄ‚îÄ RENDER HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setHistPeriod(p){
  histPeriod=p;
  document.querySelectorAll('#page-history .period-btn').forEach(b=>b.classList.toggle('active',b.dataset.period===p));
  renderHistory();
}
function renderHistory(){
  const filtered = operations.filter(o=>inPeriod(o,histPeriod));
  if(!filtered.length){
    document.getElementById('history-container').innerHTML='<div class="empty"><p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥</p></div>';
    return;
  }
  // group by date
  const groups = {};
  filtered.forEach(o=>{
    if(!groups[o.date]) groups[o.date]=[];
    groups[o.date].push(o);
  });
  const sorted = Object.keys(groups).sort((a,b)=>b.localeCompare(a));
  document.getElementById('history-container').innerHTML = sorted.map(date=>{
    const ops = groups[date];
    const total = ops.reduce((s,o)=>s+(o.type==='expense'?-o.amount:o.amount),0);
    const sign = total>=0?'+':'‚àí';
    return `<div>
      <div class="history-date">
        <span>${formatDate(date)}</span>
        <span class="date-total" style="color:${total>=0?'var(--green)':'var(--red)'}">${sign}${fmtVND(Math.abs(total))} ‚Ç´</span>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        ${ops.sort((a,b)=>b.id.localeCompare(a.id)).map(o=>opCardHTML(o)).join('')}
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ RENDER REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setRepPeriod(p){
  repPeriod=p;
  document.querySelectorAll('#page-reports .period-btn').forEach(b=>b.classList.toggle('active',b.dataset.period===p));
  renderReports();
}
function renderReports(){
  const filtered = operations.filter(o=>inPeriod(o,repPeriod));
  const expenses = filtered.filter(o=>o.type==='expense');
  const incomes  = filtered.filter(o=>o.type==='income');
  const totalExp = expenses.reduce((s,o)=>s+o.amount,0);
  const totalInc = incomes.reduce((s,o)=>s+o.amount,0);

  // by category
  const byCat = {};
  expenses.forEach(o=>{
    byCat[o.category]=(byCat[o.category]||0)+o.amount;
  });
  const catsSorted = Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
  const maxCat = catsSorted[0]?catsSorted[0][1]:1;

  document.getElementById('reports-container').innerHTML = `
    <div class="report-summary">
      <div class="summary-card"><div class="s-label">–†–ê–°–•–û–î–´</div><div class="s-val red">${fmtVND(totalExp)} ‚Ç´</div></div>
      <div class="summary-card"><div class="s-label">–î–û–•–û–î–´</div><div class="s-val green">${fmtVND(totalInc)} ‚Ç´</div></div>
    </div>
    <div class="report-bar">
      <div class="report-bar-title">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
      ${catsSorted.length ? catsSorted.map(([catId,val])=>{
        const cat = categories.find(c=>c.id===catId)||{name:'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',color:'#666'};
        const pct = (val/maxCat*100).toFixed(1);
        return `<div class="bar-item">
          <div class="bar-label">
            <span class="cat-name">${cat.icon||''} ${cat.name}</span>
            <span class="cat-val">${fmtVND(val)} ‚Ç´</span>
          </div>
          <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${cat.color}"></div></div>
        </div>`;
      }).join('') : '<p style="color:var(--text3);font-size:13px">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥</p>'}
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ RENDER SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSettings(){
  document.getElementById('setting-budget').textContent = fmtVND(weeklyBudget) + ' ‚Ç´';
  document.getElementById('setting-weekday').textContent = DAYS[weekStartDay];
  const cl = document.getElementById('cats-list');
  cl.innerHTML = categories.map(c=>`
    <div class="cat-item">
      <div class="cat-dot" style="background:${c.color}"></div>
      <span style="font-size:18px">${c.icon}</span>
      <span class="cat-name-text">${c.name}</span>
      <button class="cat-del" onclick="confirmDeleteCat('${c.id}')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
      </button>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ MODAL: ADD/EDIT OP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddOpModal(opId=null, prefillCat=null){
  editingOpId = opId;
  selectedType = 'expense';
  selectedCat = prefillCat;

  if(opId){
    const op = operations.find(o=>o.id===opId);
    if(op){
      selectedType = op.type;
      selectedCat = op.category;
      document.getElementById('op-amount').value = fmtVND(op.amount);
      document.getElementById('op-comment').value = op.comment||'';
      document.getElementById('op-date').value = op.date;
      document.getElementById('op-date-group').style.display='block';
      document.getElementById('op-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
      document.getElementById('op-del-btn').style.display='block';
    }
  } else {
    document.getElementById('op-amount').value = '';
    document.getElementById('op-comment').value = '';
    document.getElementById('op-date').value = dateStr();
    document.getElementById('op-date-group').style.display='none';
    document.getElementById('op-modal-title').textContent = '–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è';
    document.getElementById('op-del-btn').style.display='none';
    renderSuggestions(0);
  }

  // type buttons
  updateTypeButtons();

  // cats picker
  const cp = document.getElementById('cats-picker');
  cp.innerHTML = categories.map(c=>`
    <div class="cat-pick ${c.id===selectedCat?'selected':''}" onclick="selectCat('${c.id}')">
      <span class="dot" style="background:${c.color}"></span>${c.icon} ${c.name}
    </div>`).join('');

  openModal('overlay-op');
}
function openEditOpModal(id){ openAddOpModal(id); }

function selectType(t){
  selectedType=t;
  updateTypeButtons();
}
function updateTypeButtons(){
  document.getElementById('type-expense').className='type-btn expense'+(selectedType==='expense'?' active':'');
  document.getElementById('type-income').className='type-btn income'+(selectedType==='income'?' active':'');
}
function selectCat(id){
  selectedCat=id;
  document.querySelectorAll('#cats-picker .cat-pick').forEach(el=>{
    el.classList.toggle('selected', el.onclick.toString().includes("'"+id+"'"));
  });
  // re-render cleaner way
  document.querySelectorAll('#cats-picker .cat-pick').forEach(el=>{
    const elId = el.getAttribute('onclick').match(/'([^']+)'/)[1];
    el.classList.toggle('selected', elId===id);
  });
}
function saveOperation(){
  const amountRaw = parseVND(document.getElementById('op-amount').value);
  if(!amountRaw){ alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É'); return; }
  if(!selectedCat){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }

  if(editingOpId){
    const idx = operations.findIndex(o=>o.id===editingOpId);
    if(idx>-1){
      operations[idx] = {...operations[idx],
        amount: amountRaw,
        type: selectedType,
        category: selectedCat,
        comment: document.getElementById('op-comment').value.trim(),
        date: document.getElementById('op-date').value
      };
    }
  } else {
    operations.push({
      id: 'op_'+Date.now(),
      amount: amountRaw,
      type: selectedType,
      category: selectedCat,
      comment: document.getElementById('op-comment').value.trim(),
      date: dateStr(),
      createdAt: new Date().toISOString()
    });
  }
  save('ops', operations);
  closeModal('overlay-op');
  renderHome();
  if(currentPage==='history') renderHistory();
  if(currentPage==='reports') renderReports();
}
function deleteCurrentOp(){
  if(!editingOpId) return;
  operations = operations.filter(o=>o.id!==editingOpId);
  save('ops', operations);
  closeModal('overlay-op');
  renderHome();
  if(currentPage==='history') renderHistory();
  if(currentPage==='reports') renderReports();
}

// ‚îÄ‚îÄ‚îÄ MODAL: BUDGET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openBudgetModal(){
  document.getElementById('budget-input').value = weeklyBudget ? fmtVND(weeklyBudget) : '';
  openModal('overlay-budget');
}
function saveBudget(){
  weeklyBudget = parseVND(document.getElementById('budget-input').value);
  save('budget', weeklyBudget);
  closeModal('overlay-budget');
  renderSettings();
  renderHome();
}

// ‚îÄ‚îÄ‚îÄ MODAL: WEEKDAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openWeekdayModal(){
  selectedWeekday = weekStartDay;
  const picker = document.getElementById('weekday-picker');
  picker.innerHTML = DAYS.map((d,i)=>`
    <button class="wd-btn ${i===selectedWeekday?'active':''}" onclick="selectWeekday(${i})">${d}</button>`).join('');
  openModal('overlay-weekday');
}
function selectWeekday(i){
  selectedWeekday=i;
  document.querySelectorAll('.wd-btn').forEach((b,j)=>b.classList.toggle('active',j===i));
}
function saveWeekday(){
  weekStartDay=selectedWeekday;
  save('weekStart',weekStartDay);
  closeModal('overlay-weekday');
  renderSettings();
  renderHome();
}

// ‚îÄ‚îÄ‚îÄ MODAL: ADD CAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddCatModal(){
  selectedColor=COLORS[0]; selectedIcon=ICONS[0];
  document.getElementById('cat-name-input').value='';
  // color picker
  document.getElementById('color-picker').innerHTML = COLORS.map((c,i)=>`
    <div class="color-opt ${i===0?'selected':''}" style="background:${c}" onclick="selectColor('${c}',this)"></div>`).join('');
  // icon picker
  iconEditMode = false;
  renderIconPicker();
  openModal('overlay-cat');
}
function renderIconPicker(){
  const picker = document.getElementById('icon-picker');
  picker.innerHTML = ICONS.map((ic,i)=>`
    <div class="emoji-wrap">
      <div class="cat-pick ${ic===selectedIcon?'selected':''}" onclick="selectIcon('${ic}',this)" style="font-size:18px;padding:6px 10px">${ic}</div>
      ${iconEditMode?`<span class="emoji-del-x" onclick="removeIconFromList('${ic}')">√ó</span>`:''}
    </div>`).join('')
    + `<div id="emoji-add-btn" class="cat-pick" onclick="addCustomEmoji()" style="font-size:18px;padding:6px 10px;color:var(--text3);border-style:dashed">+</div>`;
}
let iconEditMode = false;
function toggleIconEditMode(){
  iconEditMode = !iconEditMode;
  const btn = document.getElementById('icon-edit-toggle');
  btn.textContent = iconEditMode ? '–ì–æ—Ç–æ–≤–æ' : '–ò–∑–º–µ–Ω–∏—Ç—å';
  btn.style.color = iconEditMode ? 'var(--accent)' : 'var(--text3)';
  const row = document.getElementById('custom-emoji-row');
  if(row) row.remove();
  renderIconPicker();
}
function removeIconFromList(ic){
  const idx = ICONS.indexOf(ic);
  if(idx>-1) ICONS.splice(idx,1);
  if(selectedIcon===ic) selectedIcon = ICONS[0]||'';
  renderIconPicker();
}
function selectColor(c,el){
  selectedColor=c;
  document.querySelectorAll('.color-opt').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
}
function selectIcon(ic,el){
  selectedIcon=ic;
  document.querySelectorAll('#icon-picker .cat-pick').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
}
function addCustomEmoji(){
  // show inline input row below picker
  let existing = document.getElementById('custom-emoji-row');
  if(existing){ existing.querySelector('input').focus(); return; }
  const row = document.createElement('div');
  row.id = 'custom-emoji-row';
  row.style = 'display:flex;gap:8px;margin-top:8px;align-items:center';
  row.innerHTML = `
    <input id="custom-emoji-input" type="text" maxlength="4"
      placeholder="üéâ" class="form-input"
      style="width:80px;text-align:center;font-size:22px;padding:8px"/>
    <button onclick="confirmCustomEmoji()" class="btn btn-primary" style="flex:1;padding:10px;font-size:13px">–î–æ–±–∞–≤–∏—Ç—å</button>`;
  document.getElementById('icon-picker').after(row);
  row.querySelector('input').focus();
}
function confirmCustomEmoji(){
  const val = document.getElementById('custom-emoji-input').value.trim();
  if(!val) return;
  const ic = [...val][0];
  if(!ICONS.includes(ic)) ICONS.push(ic);
  selectedIcon = ic;
  const row = document.getElementById('custom-emoji-row');
  if(row) row.remove();
  renderIconPicker();
}
function saveCategory(){
  const name = document.getElementById('cat-name-input').value.trim();
  if(!name){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
  categories.push({id:'c_'+Date.now(),name,color:selectedColor,icon:selectedIcon});
  save('cats',categories);
  closeModal('overlay-cat');
  renderSettings();
  renderHome();
}

// ‚îÄ‚îÄ‚îÄ CONFIRM DELETE CAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmDeleteCat(catId){
  const cat = categories.find(c=>c.id===catId);
  const count = operations.filter(o=>o.category===catId).length;
  document.getElementById('confirm-title').textContent = `–£–¥–∞–ª–∏—Ç—å ¬´${cat.name}¬ª?`;
  document.getElementById('confirm-text').textContent = `–≠—Ç–æ —É–¥–∞–ª–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ ${count} –æ–ø–µ—Ä–∞—Ü–∏${count===1?'—é':count<5?'–∏':'–π'} –Ω–∞–≤—Å–µ–≥–¥–∞. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–ª—å–∑—è.`;
  document.getElementById('confirm-ok-btn').onclick = ()=>{
    categories = categories.filter(c=>c.id!==catId);
    operations = operations.filter(o=>o.category!==catId);
    save('cats',categories); save('ops',operations);
    closeModal('overlay-confirm');
    renderSettings();
    renderHome();
  };
  openModal('overlay-confirm');
}

// ‚îÄ‚îÄ‚îÄ OVERLAY HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function closeOverlay(id,e){
  if(e.target.id===id) closeModal(id);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderHome();

// ‚îÄ‚îÄ‚îÄ –ê–í–¢–û-–û–ë–ù–û–í–õ–ï–ù–ò–ï –í 00:00 –ü–û –í–¨–ï–¢–ù–ê–ú–£ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function scheduleMidnightRefresh(){
  const now = getVNNow();
  const msUntilMidnight = (
    (24 - now.getHours()) * 3600 -
    now.getMinutes() * 60 -
    now.getSeconds()
  ) * 1000;
  setTimeout(()=>{
    renderHome();
    if(currentPage==='history') renderHistory();
    if(currentPage==='reports') renderReports();
    scheduleMidnightRefresh();
  }, msUntilMidnight);
}
scheduleMidnightRefresh();
</script>
</body>
</html>
