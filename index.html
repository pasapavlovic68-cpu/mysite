<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Budget ¬∑ VND</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0f14;
  --surface:#161921;
  --surface2:#1e2330;
  --surface3:#252c3d;
  --border:#2a3347;
  --accent:#f5a623;
  --accent2:#e8845a;
  --green:#4ecca3;
  --red:#ff6b7a;
  --text:#eef0f6;
  --text2:#8892a4;
  --text3:#505a70;
  --radius:16px;
  --radius-sm:10px;
}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;max-width:430px;margin:0 auto;position:relative;overflow-x:hidden}
body::before{content:'';position:fixed;top:-200px;right:-100px;width:400px;height:400px;background:radial-gradient(circle,rgba(245,166,35,.07) 0%,transparent 70%);pointer-events:none;z-index:0}

/* LAYOUT */
#app{display:flex;flex-direction:column;min-height:100dvh;position:relative;z-index:1}
.page{flex:1;overflow-y:auto;padding:0 0 90px;display:none}
.page.active{display:block}
nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(22,25,33,.95);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;z-index:100;padding:8px 0 env(safe-area-inset-bottom,8px)}
nav button{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;background:none;border:none;color:var(--text3);font-family:'Sora',sans-serif;font-size:10px;font-weight:500;cursor:pointer;padding:6px 0;transition:.2s;letter-spacing:.3px}
nav button svg{width:22px;height:22px;transition:.2s}
nav button.active{color:var(--accent)}
nav button.active svg{filter:drop-shadow(0 0 6px rgba(245,166,35,.5))}

/* FAB */
.fab{position:fixed;bottom:74px;right:max(16px, calc(50% - 199px));z-index:101;width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff;font-size:26px;cursor:pointer;box-shadow:0 4px 24px rgba(245,166,35,.4);transition:.2s;display:flex;align-items:center;justify-content:center}
.fab:hover{transform:scale(1.08);box-shadow:0 6px 32px rgba(245,166,35,.5)}
.fab:active{transform:scale(.95)}

/* HEADER */
.page-header{padding:52px 20px 20px;position:sticky;top:0;background:var(--bg);z-index:10}
.page-header h1{font-size:22px;font-weight:700;letter-spacing:-.3px}
.page-header p{color:var(--text2);font-size:13px;margin-top:2px}

/* HOME */
.home-hero{margin:16px 20px 0;background:linear-gradient(135deg,var(--surface2),var(--surface));border:1px solid var(--border);border-radius:24px;padding:28px 24px;position:relative;overflow:hidden}
.home-hero::before{content:'';position:absolute;top:-30px;right:-30px;width:150px;height:150px;background:radial-gradient(circle,rgba(245,166,35,.12),transparent 70%)}
.hero-label{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:1px;text-transform:uppercase}
.hero-amount{font-family:'JetBrains Mono',monospace;font-size:38px;font-weight:500;letter-spacing:-1px;margin:6px 0;line-height:1}
.hero-amount.positive{color:var(--green)}
.hero-amount.negative{color:var(--red)}
.hero-sub{display:flex;gap:20px;margin-top:18px;padding-top:16px;border-top:1px solid var(--border)}
.hero-sub-item{flex:1}
.hero-sub-item .lbl{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.hero-sub-item .val{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:500;margin-top:3px}
.hero-sub-item .val.pos{color:var(--green)}
.hero-sub-item .val.neg{color:var(--red)}

.section-title{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:1px;text-transform:uppercase;padding:24px 20px 10px}
.quick-cats{display:flex;gap:10px;padding:0 20px;overflow-x:auto;scrollbar-width:none}
.quick-cats::-webkit-scrollbar{display:none}
.quick-cat{flex:0 0 auto;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:.15s;font-size:13px;font-weight:500}
.quick-cat:hover{border-color:var(--accent);background:var(--surface2)}
.quick-cat .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

.recent-ops{padding:0 20px;display:flex;flex-direction:column;gap:8px}
.op-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:.15s}
.op-card:hover{border-color:var(--border);background:var(--surface2)}
.op-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.op-info{flex:1;min-width:0}
.op-name{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.op-meta{font-size:11px;color:var(--text3);margin-top:2px}
.op-amount{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:500;flex-shrink:0}
.op-amount.expense{color:var(--red)}
.op-amount.income{color:var(--green)}

/* HISTORY */
.history-group{padding:0 20px;margin-bottom:4px}
.history-date{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;padding:20px 0 8px;display:flex;justify-content:space-between;align-items:center}
.history-date .date-total{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:500}

/* REPORTS */
.report-section{padding:0 20px;margin-bottom:20px}
.report-bar{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.report-bar-title{font-size:12px;color:var(--text2);margin-bottom:16px;font-weight:500}
.bar-item{margin-bottom:12px}
.bar-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:5px}
.bar-label .cat-name{font-weight:500}
.bar-label .cat-val{font-family:'JetBrains Mono',monospace;color:var(--text2)}
.bar-track{height:6px;background:var(--surface3);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px;transition:width .4s ease}

.report-summary{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.summary-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px}
.summary-card .s-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:600}
.summary-card .s-val{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:500;margin-top:6px}
.summary-card .s-val.red{color:var(--red)}
.summary-card .s-val.green{color:var(--green)}

/* SETTINGS */
.settings-section{padding:0 20px;margin-bottom:24px}
.settings-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border);cursor:pointer;transition:.15s;gap:12px}
.settings-row:last-child{border-bottom:none}
.settings-row:hover{background:var(--surface2)}
.settings-row .row-label{font-size:14px;font-weight:500}
.settings-row .row-sub{font-size:11px;color:var(--text3);margin-top:2px}
.settings-row .row-val{font-size:13px;color:var(--accent);font-family:'JetBrains Mono',monospace;flex-shrink:0}

.cats-list{display:flex;flex-direction:column;gap:8px}
.cat-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;display:flex;align-items:center;gap:12px}
.cat-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.cat-name-text{flex:1;font-size:14px;font-weight:500}
.cat-del{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;border-radius:6px;transition:.15s;display:flex}
.cat-del:hover{color:var(--red);background:rgba(255,107,122,.1)}

/* MODALS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:200;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:.25s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border-radius:24px 24px 0 0;width:100%;max-width:430px;margin:0 auto;padding:24px 20px calc(env(safe-area-inset-bottom,0px) + 24px);transform:translateY(100%);transition:.3s cubic-bezier(.32,1,.35,1);max-height:90dvh;overflow-y:auto}
.overlay.open .modal{transform:translateY(0)}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px}
.modal-title{font-size:18px;font-weight:700;margin-bottom:20px;letter-spacing:-.2px}

/* FORM */
.form-group{margin-bottom:16px}
.form-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;display:block}
.form-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:13px 16px;color:var(--text);font-family:'Sora',sans-serif;font-size:15px;outline:none;transition:.2s}
.form-input:focus{border-color:var(--accent);background:var(--surface3)}
.form-input::placeholder{color:var(--text3)}
.amount-input-wrap{position:relative}
.amount-input-wrap .currency{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--text3);font-weight:600;pointer-events:none}
.amount-suggestions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.suggestion{background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:12px;font-family:'JetBrains Mono',monospace;cursor:pointer;color:var(--text2);transition:.15s}
.suggestion:hover{border-color:var(--accent);color:var(--accent)}

.type-toggle{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.type-btn{padding:11px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-family:'Sora',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:.2s}
.type-btn.active.expense{background:rgba(255,107,122,.15);border-color:var(--red);color:var(--red)}
.type-btn.active.income{background:rgba(78,204,163,.15);border-color:var(--green);color:var(--green)}

.cats-picker{display:flex;flex-wrap:wrap;gap:8px}
.cat-pick{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);cursor:pointer;font-size:12px;font-weight:500;transition:.15s}
.cat-pick.selected{border-color:var(--accent);background:rgba(245,166,35,.1);color:var(--accent)}
.cat-pick .dot{width:8px;height:8px;border-radius:50%}

.btn{width:100%;padding:14px;border-radius:var(--radius-sm);border:none;font-family:'Sora',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:.2s;letter-spacing:.2px}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 4px 20px rgba(245,166,35,.3)}
.btn-primary:hover{box-shadow:0 6px 28px rgba(245,166,35,.4)}
.btn-primary:active{transform:scale(.98)}
.btn-danger{background:rgba(255,107,122,.15);color:var(--red);border:1px solid rgba(255,107,122,.3)}
.btn-ghost{background:var(--surface2);color:var(--text2);border:1px solid var(--border);margin-top:8px}

.color-picker{display:flex;gap:8px;flex-wrap:wrap}
.color-opt{width:32px;height:32px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:.15s}
.color-opt.selected{border-color:var(--text)}

.emoji-wrap{position:relative;display:inline-flex}
.emoji-del-x{position:absolute;top:-6px;right:-6px;width:16px;height:16px;background:var(--red);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;cursor:pointer;font-weight:700;line-height:1;z-index:5;border:1.5px solid var(--bg)}

.week-day-picker{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.wd-btn{padding:8px 4px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-size:11px;font-weight:600;cursor:pointer;transition:.15s;text-align:center}
.wd-btn.active{background:rgba(245,166,35,.15);border-color:var(--accent);color:var(--accent)}

.budget-period{display:flex;justify-content:flex-end;gap:6px;padding:0 20px 0}
.period-btn{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--surface);color:var(--text3);cursor:pointer;transition:.15s;font-family:'Sora',sans-serif}
.period-btn.active{background:var(--accent);border-color:var(--accent);color:#000}

.empty{text-align:center;padding:60px 20px;color:var(--text3)}
.empty svg{width:48px;height:48px;opacity:.3;margin-bottom:12px}
.empty p{font-size:14px}

.confirm-btns{display:flex;flex-direction:column;gap:8px;margin-top:8px}

/* COLLAPSIBLE GROUPS */
.coll-group{margin-bottom:8px}
.coll-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:.15s;gap:10px}
.coll-header:hover{background:var(--surface2)}
.coll-header.open{border-radius:var(--radius-sm) var(--radius-sm) 0 0;border-bottom-color:transparent}
.coll-period{font-size:13px;font-weight:600;color:var(--text)}
.coll-stats{display:flex;align-items:center;gap:8px;flex-shrink:0}
.coll-exp{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--red)}
.coll-inc{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--green)}
.coll-chevron{font-size:16px;color:var(--text3);transition:transform .2s;line-height:1}
.coll-header.open .coll-chevron{transform:rotate(90deg)}
.coll-body{background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);overflow:hidden}
.coll-day{border-top:1px solid var(--border)}
.coll-day:first-child{border-top:none}
.coll-day-header{display:flex;align-items:center;gap:8px;padding:10px 16px;cursor:pointer;transition:.15s}
.coll-day-header:hover{background:var(--surface2)}
.coll-day-header.open .coll-chevron{transform:rotate(90deg)}
.coll-day-label{font-size:12px;font-weight:600;color:var(--text2);flex:1}
.coll-day-total{font-family:'JetBrains Mono',monospace;font-size:12px}
.coll-day-body{padding:0 10px 10px}
.coll-day-body .op-card{border-radius:8px;margin-top:6px}
.cat-type-toggle{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:0}
.cat-type-btn{padding:9px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-family:'Sora',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:.2s}
.cat-type-btn.active.expense{background:rgba(255,107,122,.15);border-color:var(--red);color:var(--red)}
.cat-type-btn.active.income{background:rgba(78,204,163,.15);border-color:var(--green);color:var(--green)}

/* LOGIN */
#login-screen{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;max-width:430px;margin:0 auto}
#login-screen h1{font-size:28px;font-weight:700;margin-bottom:6px;letter-spacing:-.5px}
#login-screen p{color:var(--text2);font-size:13px;margin-bottom:36px;text-align:center;line-height:1.6}
#login-screen .logo{font-size:48px;margin-bottom:20px}
.login-error{color:var(--red);font-size:12px;margin-top:8px;min-height:16px;text-align:center}

/* SYNC INDICATOR */
#sync-indicator{position:fixed;top:env(safe-area-inset-top,0px);right:0;left:0;max-width:430px;margin:0 auto;z-index:500;pointer-events:none}
.sync-badge{display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:0 0 10px 10px;padding:6px 14px;font-size:11px;color:var(--text3);width:fit-content;margin:0 auto;opacity:0;transition:.3s;font-weight:500}
.sync-badge.show{opacity:1}
.sync-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
</style>
</head>
<body>
<!-- SYNC INDICATOR -->
<div id="sync-indicator"><div class="sync-badge" id="sync-badge"><span class="sync-dot"></span> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div></div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="logo">üí∞</div>
  <h1>Budget VND</h1>
  <p>–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ<br>—Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ –æ–±–ª–∞–∫–µ</p>
  <div class="form-group" style="width:100%;max-width:340px">
    <label class="form-label">Email</label>
    <input class="form-input" id="login-email" type="email" placeholder="your@email.com" autocomplete="email"/>
  </div>
  <div class="form-group" style="width:100%;max-width:340px">
    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
    <input class="form-input" id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
      onkeydown="if(event.key==='Enter')doLogin()"/>
  </div>
  <div class="login-error" id="login-error"></div>
  <button class="btn btn-primary" style="width:100%;max-width:340px;margin-top:12px" onclick="doLogin()">–í–æ–π—Ç–∏</button>
</div>

<div id="app">
  <!-- PAGES -->
  <div class="page active" id="page-home">
    <div class="page-header">
      <h1 id="greeting">–ü—Ä–∏–≤–µ—Ç üëã</h1>
      <p id="today-date"></p>
    </div>
    <!-- hero -->
    <div class="home-hero">
      <div class="hero-label">–û–°–¢–ê–õ–û–°–¨ –ù–ê –°–ï–ì–û–î–ù–Ø</div>
      <div class="hero-amount" id="hero-today">0 ‚Ç´</div>
      <div class="hero-sub">
        <div class="hero-sub-item">
          <div class="lbl">–ù–ê –ù–ï–î–ï–õ–Æ</div>
          <div class="val" id="hero-week">0 ‚Ç´</div>
        </div>
        <div class="hero-sub-item">
          <div class="lbl">–î–ù–ï–í–ù–û–ô –õ–ò–ú–ò–¢</div>
          <div class="val" id="hero-daily">0 ‚Ç´</div>
        </div>
      </div>
    </div>
    <!-- quick categories -->
    <div class="section-title">–ö–ê–¢–ï–ì–û–†–ò–ò</div>
    <div class="quick-cats" id="quick-cats"></div>
    <!-- recent -->
    <div class="section-title">–ü–û–°–õ–ï–î–ù–ò–ï –û–ü–ï–†–ê–¶–ò–ò</div>
    <div class="recent-ops" id="recent-ops"></div>
  </div>

  <div class="page" id="page-history">
    <div class="page-header" style="padding-bottom:12px">
      <h1>–ò—Å—Ç–æ—Ä–∏—è</h1>
    </div>
    <div style="padding:0 20px 10px;display:flex;gap:6px;justify-content:flex-end">
      <button class="period-btn active" data-period="week" onclick="setHistPeriod('week')">–ù–µ–¥–µ–ª—è</button>
      <button class="period-btn" data-period="month" onclick="setHistPeriod('month')">–ú–µ—Å—è—Ü</button>
      <button class="period-btn" data-period="all" onclick="setHistPeriod('all')">–í—Å—ë</button>
    </div>
    <div id="history-container" style="padding:0 20px"></div>
  </div>

  <div class="page" id="page-reports">
    <div class="page-header" style="padding-bottom:12px">
      <h1>–û—Ç—á—ë—Ç—ã</h1>
    </div>
    <div style="padding:0 20px 10px;display:flex;gap:6px;justify-content:flex-end">
      <button class="period-btn active" data-period="week" onclick="setRepPeriod('week')">–ù–µ–¥–µ–ª—è</button>
      <button class="period-btn" data-period="month" onclick="setRepPeriod('month')">–ú–µ—Å—è—Ü</button>
      <button class="period-btn" data-period="all" onclick="setRepPeriod('all')">–í—Å—ë</button>
    </div>
    <div id="reports-container" style="padding:0 20px"></div>
  </div>

  <div class="page" id="page-settings">
    <div class="page-header"><h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1></div>
    <div class="settings-section">
      <div class="section-title" style="padding:0 0 10px">–ë–Æ–î–ñ–ï–¢</div>
      <div class="settings-card">
        <div class="settings-row" onclick="openBudgetModal()">
          <div>
            <div class="row-label">–ù–µ–¥–µ–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç</div>
            <div class="row-sub">–¢–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã</div>
          </div>
          <div class="row-val" id="setting-budget">0 ‚Ç´</div>
        </div>
        <div class="settings-row" onclick="openWeekdayModal()">
          <div>
            <div class="row-label">–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏</div>
            <div class="row-sub">–î–µ–Ω—å —Å–±—Ä–æ—Å–∞ –±—é–¥–∂–µ—Ç–∞</div>
          </div>
          <div class="row-val" id="setting-weekday">–ß—Ç</div>
        </div>
      </div>
    </div>
    <div class="settings-section">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0 0 10px">
        <div class="section-title" style="padding:0">–ö–ê–¢–ï–ì–û–†–ò–ò</div>
        <button onclick="openAddCatModal()" style="background:var(--accent);border:none;color:#000;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Sora',sans-serif">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="cats-list" id="cats-list"></div>
    </div>
    <div class="settings-section">
      <div class="settings-card">
        <div class="settings-row" onclick="doLogout()" style="color:var(--red)">
          <div>
            <div class="row-label" style="color:var(--red)">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
            <div class="row-sub" id="settings-email"></div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--red)"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </div>
      </div>
    </div>

  <!-- NAV -->
  <nav>
    <button class="active" onclick="goTo('home')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      –ì–ª–∞–≤–Ω–∞—è
    </button>
    <button onclick="goTo('history')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      –ò—Å—Ç–æ—Ä–∏—è
    </button>
    <button onclick="goTo('reports')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      –û—Ç—á—ë—Ç—ã
    </button>
    <button onclick="goTo('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    </button>
  </nav>
  <button class="fab" onclick="openAddOpModal()">+</button>
</div>

<!-- MODAL: ADD/EDIT OPERATION -->
<div class="overlay" id="overlay-op" onclick="closeOverlay('overlay-op',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="op-modal-title">–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</div>
    <div class="form-group">
      <label class="form-label">–¢–∏–ø</label>
      <div class="type-toggle">
        <button class="type-btn expense active" id="type-expense" onclick="selectType('expense')">‚Äî –†–∞—Å—Ö–æ–¥</button>
        <button class="type-btn income" id="type-income" onclick="selectType('income')">+ –î–æ—Ö–æ–¥</button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">–°—É–º–º–∞ (VND)</label>
      <div class="amount-input-wrap">
        <input class="form-input" id="op-amount" type="text" inputmode="numeric" placeholder="0" oninput="onAmountInput(this)"/>
        <span class="currency">‚Ç´</span>
      </div>
      <div class="amount-suggestions" id="amount-suggestions"></div>
    </div>
    <button class="btn btn-primary" id="op-save-btn" onclick="saveOperation()" style="margin-bottom:16px">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div class="form-group">
      <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <div class="cats-picker" id="cats-picker"></div>
    </div>
    <div class="form-group" id="op-date-group" style="display:none">
      <label class="form-label">–î–∞—Ç–∞</label>
      <input class="form-input" id="op-date" type="date"/>
    </div>
    <div class="form-group">
      <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <input class="form-input" id="op-comment" type="text" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"/>
    </div>
    <button class="btn btn-ghost" id="op-del-btn" onclick="deleteCurrentOp()" style="display:none">–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
  </div>
</div>

<!-- MODAL: BUDGET -->
<div class="overlay" id="overlay-budget" onclick="closeOverlay('overlay-budget',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–µ–¥–µ–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç</div>
    <div class="form-group">
      <label class="form-label">–°—É–º–º–∞ (VND)</label>
      <div class="amount-input-wrap">
        <input class="form-input" id="budget-input" type="text" inputmode="numeric" placeholder="0" oninput="onAmountInput(this)"/>
        <span class="currency">‚Ç´</span>
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveBudget()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- MODAL: WEEKDAY -->
<div class="overlay" id="overlay-weekday" onclick="closeOverlay('overlay-weekday',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏</div>
    <div class="form-group">
      <div class="week-day-picker" id="weekday-picker"></div>
    </div>
    <button class="btn btn-primary" onclick="saveWeekday()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- MODAL: ADD CATEGORY -->
<div class="overlay" id="overlay-cat" onclick="closeOverlay('overlay-cat',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
    <div class="form-group">
      <label class="form-label">–¢–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
      <div class="cat-type-toggle">
        <button class="cat-type-btn expense active" id="cat-type-expense" onclick="selectCatType('expense')">‚Äî –†–∞—Å—Ö–æ–¥</button>
        <button class="cat-type-btn income" id="cat-type-income" onclick="selectCatType('income')">+ –î–æ—Ö–æ–¥</button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input class="form-input" id="cat-name-input" type="text" placeholder="–ï–¥–∞, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç..."/>
    </div>
    <div class="form-group">
      <label class="form-label">–¶–≤–µ—Ç</label>
      <div class="color-picker" id="color-picker"></div>
    </div>
    <div class="form-group">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <label class="form-label" style="margin-bottom:0">–ò–∫–æ–Ω–∫–∞</label>
        <button id="icon-edit-toggle" onclick="toggleIconEditMode()" style="background:none;border:none;color:var(--text3);font-size:11px;font-weight:600;font-family:'Sora',sans-serif;cursor:pointer;letter-spacing:.5px;padding:4px 8px;border-radius:6px;transition:.15s">–ò–∑–º–µ–Ω–∏—Ç—å</button>
      </div>
      <div class="cats-picker" id="icon-picker" style="gap:6px;position:relative"></div>
    </div>
    <button class="btn btn-primary" onclick="saveCategory()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
</div>

<!-- MODAL: CONFIRM DELETE -->
<div class="overlay" id="overlay-confirm" onclick="closeOverlay('overlay-confirm',event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="confirm-title">–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?</div>
    <p style="color:var(--text2);font-size:14px;line-height:1.6;margin-bottom:20px" id="confirm-text"></p>
    <div class="confirm-btns">
      <button class="btn btn-danger" id="confirm-ok-btn">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn btn-ghost" onclick="closeModal('overlay-confirm')">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script type="module">
// ‚îÄ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc }
  from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDW6_nCv0uj4uhQ6WBNc0hOwyMlR3MnhrE",
  authDomain: "flowpay-7460e.firebaseapp.com",
  projectId: "flowpay-7460e",
  storageBucket: "flowpay-7460e.firebasestorage.app",
  messagingSenderId: "537984272877",
  appId: "1:537984272877:web:a7f8a084d8c0ceb38b7fe4"
};
const fbApp = initializeApp(firebaseConfig);
const auth  = getAuth(fbApp);
const db    = getFirestore(fbApp);

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COLORS = ['#f5a623','#e8845a','#ff6b7a','#4ecca3','#5b8dee','#a78bfa','#f472b6','#34d399','#fb923c','#818cf8'];
const ICONS  = ['üçú','üçï','üç∫','‚òï','üöó','üöå','üè†','üíä','üõçÔ∏è','üé¨','üí°','üì±','‚úàÔ∏è','üéÆ','üê∂','üìö','üí™','üéµ','üèãÔ∏è','üí∞'];
const DAYS   = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];

const DEFAULT_CATS = [
  {id:'c1',name:'–ï–¥–∞',color:'#f5a623',icon:'üçú',type:'expense'},
  {id:'c2',name:'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',color:'#5b8dee',icon:'üöó',type:'expense'},
  {id:'c3',name:'–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',color:'#a78bfa',icon:'üé¨',type:'expense'},
  {id:'c4',name:'–ó–¥–æ—Ä–æ–≤—å–µ',color:'#4ecca3',icon:'üíä',type:'expense'},
];

// localStorage cache helpers
function lsLoad(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}
function lsSave(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}

let operations   = lsLoad('ops',[]);
let categories   = lsLoad('cats',DEFAULT_CATS);
let weeklyBudget = lsLoad('budget',0);
let weekStartDay = lsLoad('weekStart',4);
let histPeriod   = 'week';
let repPeriod    = 'week';
let currentPage  = 'home';
let currentUser  = null;
let syncTimer    = null;

// ‚îÄ‚îÄ‚îÄ FIRESTORE SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFromCloud(){
  if(!currentUser) return;
  try{
    const ref = doc(db, 'users', currentUser.uid, 'appdata', 'main');
    const snap = await getDoc(ref);
    if(snap.exists()){
      const d = snap.data();
      if(d.operations)   operations   = d.operations;
      if(d.categories)   categories   = d.categories;
      if(d.weeklyBudget !== undefined) weeklyBudget = d.weeklyBudget;
      if(d.weekStartDay !== undefined) weekStartDay = d.weekStartDay;
      // update local cache
      lsSave('ops', operations);
      lsSave('cats', categories);
      lsSave('budget', weeklyBudget);
      lsSave('weekStart', weekStartDay);
    }
    renderAll();
  } catch(e){ console.warn('Cloud load error:', e); }
}

function saveToCloud(){
  if(!currentUser) return;
  clearTimeout(syncTimer);
  syncTimer = setTimeout(async ()=>{
    showSync(true);
    try{
      const ref = doc(db, 'users', currentUser.uid, 'appdata', 'main');
      await setDoc(ref, { operations, categories, weeklyBudget, weekStartDay });
      // update local cache
      lsSave('ops', operations);
      lsSave('cats', categories);
      lsSave('budget', weeklyBudget);
      lsSave('weekStart', weekStartDay);
    } catch(e){ console.warn('Cloud save error:', e); }
    showSync(false);
  }, 1500);
}

function showSync(on){
  const b = document.getElementById('sync-badge');
  b.classList.toggle('show', on);
}

function save(k,v){
  if(k==='ops')         operations   = v;
  if(k==='cats')        categories   = v;
  if(k==='budget')      weeklyBudget = v;
  if(k==='weekStart')   weekStartDay = v;
  saveToCloud();
}

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.doLogin = async function(){
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';
  if(!email||!pass){ errEl.textContent='–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'; return; }
  try{
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e){
    const msgs = {
      'auth/invalid-credential':'–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å',
      'auth/user-not-found':'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
      'auth/wrong-password':'–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
      'auth/too-many-requests':'–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫, –ø–æ–¥–æ–∂–¥–∏—Ç–µ',
    };
    errEl.textContent = msgs[e.code] || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: '+e.message;
  }
};

window.doLogout = async function(){
  await signOut(auth);
};

onAuthStateChanged(auth, async user => {
  currentUser = user;
  const loginScreen = document.getElementById('login-screen');
  const appEl       = document.getElementById('app');
  if(user){
    loginScreen.style.display = 'none';
    appEl.style.display = '';
    const emailEl = document.getElementById('settings-email');
    if(emailEl) emailEl.textContent = user.email;
    await loadFromCloud();
  } else {
    loginScreen.style.display = 'flex';
    appEl.style.display = 'none';
  }
});

// ‚îÄ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtVND(n){
  if(n==null||isNaN(n))return '0';
  return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
}
function parseVND(s){
  return parseInt(s.replace(/[^\d]/g,''))||0;
}
window.onAmountInput = function(el){
  let raw = el.value.replace(/[^\d]/g,'');
  let num = parseInt(raw)||0;
  el.value = raw ? fmtVND(num) : '';
  if(el.id === 'op-amount') renderSuggestions(num);
};
function renderSuggestions(num){
  const box = document.getElementById('amount-suggestions');
  if(!num){box.innerHTML='';return}
  const mults = [10,100,1000,10000];
  box.innerHTML = mults.map(m=>`<span class="suggestion" onclick="applySuggestion(${num*m})">${fmtVND(num*m)}</span>`).join('');
}
window.applySuggestion = function(val){
  document.getElementById('op-amount').value = fmtVND(val);
  renderSuggestions(val);
};

// ‚îÄ‚îÄ‚îÄ DATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getVNNow(){
  return new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Ho_Chi_Minh'}));
}
function dateStr(d=null){
  const vn = d || getVNNow();
  return vn.getFullYear()+'-'+String(vn.getMonth()+1).padStart(2,'0')+'-'+String(vn.getDate()).padStart(2,'0');
}
function getWeekStart(dayNum){
  const now = getVNNow();
  const dow = now.getDay();
  const diff = (dow - dayNum + 7) % 7;
  const start = new Date(now);
  start.setDate(now.getDate() - diff);
  start.setHours(0,0,0,0);
  return start;
}
function inPeriod(op, period){
  const d = new Date(op.date + 'T00:00:00');
  const today = getVNNow(); today.setHours(0,0,0,0);
  if(period==='week'){
    const ws = getWeekStart(weekStartDay);
    return d >= ws && d <= today;
  }
  if(period==='month'){
    const ms = new Date(today.getFullYear(), today.getMonth(), 1);
    return d >= ms && d <= today;
  }
  return true;
}

// ‚îÄ‚îÄ‚îÄ BUDGET CALC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function daysLeftInWeek(){
  const now = getVNNow();
  const dow = now.getDay();
  const d = (weekStartDay - dow + 7) % 7;
  return d === 0 ? 7 : d;
}
function calcBudget(){
  const todayStr = dateStr();
  const spentToday = operations.filter(o=>o.type==='expense'&&o.date===todayStr).reduce((s,o)=>s+o.amount,0);
  const spentWeek  = operations.filter(o=>o.type==='expense'&&inPeriod(o,'week')).reduce((s,o)=>s+o.amount,0);
  const remWeek  = weeklyBudget - spentWeek;
  const daysLeft = daysLeftInWeek();
  const daily    = daysLeft > 0 ? remWeek / daysLeft : 0;
  return { daily, remToday: daily - spentToday, remWeek, spentToday, spentWeek };
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.goTo = function(page){
  currentPage = page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelectorAll('nav button').forEach((b,i)=>{
    b.classList.toggle('active', ['home','history','reports','settings'][i]===page);
  });
  if(page==='home')     renderHome();
  if(page==='history')  renderHistory();
  if(page==='reports')  renderReports();
  if(page==='settings') renderSettings();
};

function renderAll(){
  renderHome();
  if(currentPage==='history')  renderHistory();
  if(currentPage==='reports')  renderReports();
  if(currentPage==='settings') renderSettings();
}

// ‚îÄ‚îÄ‚îÄ RENDER HOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHome(){
  const h = getVNNow().getHours();
  const greet = h<12?'–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ ‚òÄÔ∏è':h<17?'–î–æ–±—Ä—ã–π –¥–µ–Ω—å üëã':'–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä üåô';
  document.getElementById('greeting').textContent = greet;
  document.getElementById('today-date').textContent = new Date().toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'});

  const {daily, remToday, remWeek} = calcBudget();
  const heroEl = document.getElementById('hero-today');
  heroEl.textContent = fmtVND(Math.abs(remToday)) + ' ‚Ç´';
  heroEl.className = 'hero-amount ' + (remToday>=0?'positive':'negative');
  if(remToday<0) heroEl.textContent = '‚àí' + heroEl.textContent;

  const wEl = document.getElementById('hero-week');
  wEl.textContent = fmtVND(Math.abs(remWeek)) + ' ‚Ç´';
  wEl.className = 'val ' + (remWeek>=0?'pos':'neg');
  if(remWeek<0) wEl.textContent = '‚àí' + wEl.textContent;

  document.getElementById('hero-daily').textContent = fmtVND(daily) + ' ‚Ç´';

  const usageCount = {};
  operations.forEach(o=>{ usageCount[o.category]=(usageCount[o.category]||0)+1; });
  const sortedCats = [...categories].sort((a,b)=>(usageCount[b.id]||0)-(usageCount[a.id]||0));
  document.getElementById('quick-cats').innerHTML = sortedCats.map(c=>`
    <div class="quick-cat" onclick="openAddOpModal(null,'${c.id}')"><span>${c.icon}</span><span>${c.name}</span></div>`).join('');

  const recent = [...operations].sort((a,b)=>b.id.localeCompare(a.id)).slice(0,5);
  const ro = document.getElementById('recent-ops');
  if(!recent.length){ ro.innerHTML='<div class="empty"><p>–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p></div>'; return; }
  ro.innerHTML = recent.map(o=>opCardHTML(o)).join('');
}

function opCardHTML(o){
  const cat = categories.find(c=>c.id===o.category)||{name:'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',icon:'üìÅ',color:'#666'};
  const sign = o.type==='expense'?'‚àí':'+';
  return `<div class="op-card" onclick="openEditOpModal('${o.id}')">
    <div class="op-icon" style="background:${cat.color}20">${cat.icon}</div>
    <div class="op-info">
      <div class="op-name">${cat.name}${o.comment?' ¬∑ '+o.comment:''}</div>
      <div class="op-meta">${formatDate(o.date)}</div>
    </div>
    <div class="op-amount ${o.type}">${sign}${fmtVND(o.amount)} ‚Ç´</div>
  </div>`;
}

function formatDate(d){
  const today = dateStr();
  const yest  = dateStr(getVNNow());
  const yd = new Date(yest+'T00:00:00'); yd.setDate(yd.getDate()-1);
  const yesterdayStr = dateStr(yd);
  if(d===today) return '–°–µ–≥–æ–¥–Ω—è';
  if(d===yesterdayStr) return '–í—á–µ—Ä–∞';
  return new Date(d+'T00:00:00').toLocaleDateString('ru-RU',{day:'numeric',month:'short'});
}

// ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let openHistGroups = new Set();

function fmtShort(ds){
  const d = new Date(ds+'T00:00:00');
  return String(d.getDate()).padStart(2,'0')+'.'+String(d.getMonth()+1).padStart(2,'0');
}
function fmtMonthYear(ds){
  return new Date(ds+'T00:00:00').toLocaleDateString('ru-RU',{month:'long',year:'numeric'});
}
function getWeekKeyForDs(ds){
  const d = new Date(ds+'T00:00:00');
  const diff = (d.getDay()-weekStartDay+7)%7;
  d.setDate(d.getDate()-diff);
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}
function getWeekEndKeyForStart(startDs){
  const d = new Date(startDs+'T00:00:00');
  d.setDate(d.getDate()+6);
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}
function weekRangeLabel(startDs){
  const endDs = getWeekEndKeyForStart(startDs);
  const sd = new Date(startDs+'T00:00:00');
  const ed = new Date(endDs+'T00:00:00');
  return `${DAYS[sd.getDay()]} ${fmtShort(startDs)} ‚Äî ${DAYS[ed.getDay()]} ${fmtShort(endDs)}`;
}

window.toggleHistGroup = function(key){
  if(openHistGroups.has(key)) openHistGroups.delete(key); else openHistGroups.add(key);
  renderHistory();
};
window.setHistPeriod = function(p){
  histPeriod=p; openHistGroups.clear();
  document.querySelectorAll('#page-history .period-btn').forEach(b=>b.classList.toggle('active',b.dataset.period===p));
  renderHistory();
};

function renderHistory(){
  const filtered = operations.filter(o=>inPeriod(o,histPeriod));
  const container = document.getElementById('history-container');
  if(!filtered.length){ container.innerHTML='<div class="empty"><p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥</p></div>'; return; }
  const byDay={};
  filtered.forEach(o=>{ if(!byDay[o.date])byDay[o.date]=[]; byDay[o.date].push(o); });
  if(histPeriod==='week') container.innerHTML = renderWeekGroups(byDay, true);
  else container.innerHTML = renderMonthGroups(byDay);
}

function dayBlock_inner(date,ops){
  const key='day_'+date;
  const isOpen=openHistGroups.has(key);
  const exp=ops.filter(o=>o.type==='expense').reduce((s,o)=>s+o.amount,0);
  const inc=ops.filter(o=>o.type==='income').reduce((s,o)=>s+o.amount,0);
  const label=new Date(date+'T00:00:00').toLocaleDateString('ru-RU',{day:'numeric',month:'short',weekday:'short'});
  return `<div class="coll-day">
    <div class="coll-day-header ${isOpen?'open':''}" onclick="toggleHistGroup('${key}')">
      <span class="coll-day-label">${label}</span>
      ${exp?`<span class="coll-exp" style="font-family:'JetBrains Mono',monospace;font-size:11px">‚àí${fmtVND(exp)}</span>`:''}
      ${inc?`<span class="coll-inc" style="font-family:'JetBrains Mono',monospace;font-size:11px">+${fmtVND(inc)}</span>`:''}
      <span class="coll-chevron">‚Ä∫</span>
    </div>
    ${isOpen?`<div class="coll-day-body">${ops.sort((a,b)=>b.id.localeCompare(a.id)).map(o=>opCardHTML(o)).join('')}</div>`:''}
  </div>`;
}

function renderWeekGroups(byDay, singleWeek){
  const weekMap={};
  Object.keys(byDay).forEach(ds=>{
    const wk=getWeekKeyForDs(ds);
    if(!weekMap[wk])weekMap[wk]=[];
    weekMap[wk]=weekMap[wk].concat(byDay[ds].map(o=>({...o,_date:ds})));
  });
  return Object.keys(weekMap).sort((a,b)=>b.localeCompare(a)).map(wk=>{
    const key='wk_'+wk;
    const isOpen=openHistGroups.has(key)||singleWeek;
    const ops=weekMap[wk];
    const exp=ops.filter(o=>o.type==='expense').reduce((s,o)=>s+o.amount,0);
    const inc=ops.filter(o=>o.type==='income').reduce((s,o)=>s+o.amount,0);
    const daysInWeek={};
    ops.forEach(o=>{ if(!daysInWeek[o._date])daysInWeek[o._date]=[]; daysInWeek[o._date].push(o); });
    const dayKeys=Object.keys(daysInWeek).sort((a,b)=>b.localeCompare(a));
    return `<div class="coll-group">
      <div class="coll-header ${isOpen?'open':''}" ${singleWeek?'':'onclick="toggleHistGroup(\''+key+'\')"'}>
        <span class="coll-period">${weekRangeLabel(wk)}</span>
        <div class="coll-stats">
          ${exp?`<span class="coll-exp">‚àí${fmtVND(exp)}</span>`:''}
          ${inc?`<span class="coll-inc">+${fmtVND(inc)}</span>`:''}
          ${singleWeek?'':'<span class="coll-chevron">‚Ä∫</span>'}
        </div>
      </div>
      ${isOpen?`<div class="coll-body">${dayKeys.map(d=>{
        const dayOps=daysInWeek[d].map(o=>operations.find(x=>x.id===o.id)||o);
        return dayBlock_inner(d,dayOps);
      }).join('')}</div>`:''}
    </div>`;
  }).join('');
}

function renderMonthGroups(byDay){
  const monthMap={};
  Object.keys(byDay).forEach(ds=>{
    const mk=ds.slice(0,7);
    if(!monthMap[mk])monthMap[mk]=[];
    monthMap[mk]=monthMap[mk].concat(byDay[ds].map(o=>({...o,_date:ds})));
  });
  return Object.keys(monthMap).sort((a,b)=>b.localeCompare(a)).map(mk=>{
    const key='mo_'+mk;
    const isOpen=openHistGroups.has(key);
    const ops=monthMap[mk];
    const exp=ops.filter(o=>o.type==='expense').reduce((s,o)=>s+o.amount,0);
    const inc=ops.filter(o=>o.type==='income').reduce((s,o)=>s+o.amount,0);
    const byDayInMonth={};
    ops.forEach(o=>{ if(!byDayInMonth[o._date])byDayInMonth[o._date]=[]; byDayInMonth[o._date].push(o); });
    return `<div class="coll-group">
      <div class="coll-header ${isOpen?'open':''}" onclick="toggleHistGroup('${key}')">
        <span class="coll-period">${fmtMonthYear(mk+'-01')}</span>
        <div class="coll-stats">
          ${exp?`<span class="coll-exp">‚àí${fmtVND(exp)}</span>`:''}
          ${inc?`<span class="coll-inc">+${fmtVND(inc)}</span>`:''}
          <span class="coll-chevron">‚Ä∫</span>
        </div>
      </div>
      ${isOpen?`<div class="coll-body">${renderWeekGroupsInner(byDayInMonth)}</div>`:''}
    </div>`;
  }).join('');
}

function renderWeekGroupsInner(byDay){
  const weekMap={};
  Object.keys(byDay).forEach(ds=>{
    const wk=getWeekKeyForDs(ds);
    if(!weekMap[wk])weekMap[wk]=[];
    weekMap[wk]=weekMap[wk].concat(byDay[ds].map(o=>({...o,_date:ds})));
  });
  return Object.keys(weekMap).sort((a,b)=>b.localeCompare(a)).map(wk=>{
    const key='wk_'+wk;
    const isOpen=openHistGroups.has(key);
    const ops=weekMap[wk];
    const exp=ops.filter(o=>o.type==='expense').reduce((s,o)=>s+o.amount,0);
    const inc=ops.filter(o=>o.type==='income').reduce((s,o)=>s+o.amount,0);
    const daysInWeek={};
    ops.forEach(o=>{ if(!daysInWeek[o._date])daysInWeek[o._date]=[]; daysInWeek[o._date].push(o); });
    return `<div class="coll-day">
      <div class="coll-day-header ${isOpen?'open':''}" onclick="toggleHistGroup('${key}')">
        <span class="coll-day-label">${weekRangeLabel(wk)}</span>
        ${exp?`<span class="coll-exp" style="font-family:'JetBrains Mono',monospace;font-size:11px">‚àí${fmtVND(exp)}</span>`:''}
        ${inc?`<span class="coll-inc" style="font-family:'JetBrains Mono',monospace;font-size:11px">+${fmtVND(inc)}</span>`:''}
        <span class="coll-chevron">‚Ä∫</span>
      </div>
      ${isOpen?`<div class="coll-day-body">${Object.keys(daysInWeek).sort((a,b)=>b.localeCompare(a)).map(d=>{
        const dayOps=daysInWeek[d].map(o=>operations.find(x=>x.id===o.id)||o);
        return dayBlock_inner(d,dayOps);
      }).join('')}</div>`:''}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let openRepGroups = new Set();

window.setRepPeriod = function(p){
  repPeriod=p; openRepGroups.clear();
  document.querySelectorAll('#page-reports .period-btn').forEach(b=>b.classList.toggle('active',b.dataset.period===p));
  renderReports();
};
window.toggleRepGroup = function(key){
  if(openRepGroups.has(key)) openRepGroups.delete(key); else openRepGroups.add(key);
  renderReports();
};

function catBarsHTML(ops){
  const byCat={};
  ops.filter(o=>o.type==='expense').forEach(o=>{ byCat[o.category]=(byCat[o.category]||0)+o.amount; });
  const sorted=Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
  const maxVal=sorted[0]?sorted[0][1]:1;
  if(!sorted.length) return '<p style="color:var(--text3);font-size:12px;padding:4px 0">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</p>';
  return sorted.map(([catId,val])=>{
    const cat=categories.find(c=>c.id===catId)||{name:'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',color:'#666',icon:''};
    const pct=(val/maxVal*100).toFixed(1);
    return `<div class="bar-item">
      <div class="bar-label"><span class="cat-name">${cat.icon} ${cat.name}</span><span class="cat-val">${fmtVND(val)} ‚Ç´</span></div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${cat.color}"></div></div>
    </div>`;
  }).join('');
}

function renderReports(){
  const filtered = operations.filter(o=>inPeriod(o,repPeriod));
  const totalExp = filtered.filter(o=>o.type==='expense').reduce((s,o)=>s+o.amount,0);
  const totalInc = filtered.filter(o=>o.type==='income').reduce((s,o)=>s+o.amount,0);
  let html=`<div class="report-summary">
    <div class="summary-card"><div class="s-label">–†–ê–°–•–û–î–´</div><div class="s-val red">${fmtVND(totalExp)} ‚Ç´</div></div>
    <div class="summary-card"><div class="s-label">–î–û–•–û–î–´</div><div class="s-val green">${fmtVND(totalInc)} ‚Ç´</div></div>
  </div>`;
  if(!filtered.length){ html+='<div class="empty"><p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥</p></div>'; document.getElementById('reports-container').innerHTML=html; return; }
  if(repPeriod==='week'){
    const dates=filtered.map(o=>o.date).sort();
    html+=`<div class="report-bar"><div class="report-bar-title">${weekRangeLabel(getWeekKeyForDs(dates[0]))}</div>${catBarsHTML(filtered)}</div>`;
  } else {
    const monthMap={};
    filtered.forEach(o=>{ const mk=o.date.slice(0,7); if(!monthMap[mk])monthMap[mk]=[]; monthMap[mk].push(o); });
    html+=Object.keys(monthMap).sort((a,b)=>b.localeCompare(a)).map(mk=>{
      const key='rep_mo_'+mk; const isOpen=openRepGroups.has(key);
      const mops=monthMap[mk];
      const mexp=mops.filter(o=>o.type==='expense').reduce((s,o)=>s+o.amount,0);
      const minc=mops.filter(o=>o.type==='income').reduce((s,o)=>s+o.amount,0);
      const weekMap2={};
      mops.forEach(o=>{ const wk=getWeekKeyForDs(o.date); if(!weekMap2[wk])weekMap2[wk]=[]; weekMap2[wk].push(o); });
      return `<div class="coll-group">
        <div class="coll-header ${isOpen?'open':''}" onclick="toggleRepGroup('${key}')">
          <span class="coll-period">${fmtMonthYear(mk+'-01')}</span>
          <div class="coll-stats">${mexp?`<span class="coll-exp">‚àí${fmtVND(mexp)}</span>`:''} ${minc?`<span class="coll-inc">+${fmtVND(minc)}</span>`:''}<span class="coll-chevron">‚Ä∫</span></div>
        </div>
        ${isOpen?`<div class="coll-body">${Object.keys(weekMap2).sort((a,b)=>b.localeCompare(a)).map(wk=>{
          const key2='rep_wk_'+wk; const isOpen2=openRepGroups.has(key2);
          const wops=weekMap2[wk];
          const wexp=wops.filter(o=>o.type==='expense').reduce((s,o)=>s+o.amount,0);
          const winc=wops.filter(o=>o.type==='income').reduce((s,o)=>s+o.amount,0);
          return `<div class="coll-day">
            <div class="coll-day-header ${isOpen2?'open':''}" onclick="toggleRepGroup('${key2}')">
              <span class="coll-day-label">${weekRangeLabel(wk)}</span>
              ${wexp?`<span class="coll-exp" style="font-family:'JetBrains Mono',monospace;font-size:11px">‚àí${fmtVND(wexp)}</span>`:''}
              ${winc?`<span class="coll-inc" style="font-family:'JetBrains Mono',monospace;font-size:11px">+${fmtVND(winc)}</span>`:''}
              <span class="coll-chevron">‚Ä∫</span>
            </div>
            ${isOpen2?`<div class="coll-day-body" style="padding:12px 16px"><div class="report-bar" style="margin:0;padding:0;border:none;background:none">${catBarsHTML(wops)}</div></div>`:''}
          </div>`;
        }).join('')}</div>`:''}
      </div>`;
    }).join('');
  }
  document.getElementById('reports-container').innerHTML=html;
}

// ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSettings(){
  document.getElementById('setting-budget').textContent = fmtVND(weeklyBudget) + ' ‚Ç´';
  document.getElementById('setting-weekday').textContent = DAYS[weekStartDay];
  const emailEl = document.getElementById('settings-email');
  if(emailEl && currentUser) emailEl.textContent = currentUser.email;
  document.getElementById('cats-list').innerHTML = categories.map(c=>`
    <div class="cat-item">
      <div class="cat-dot" style="background:${c.color}"></div>
      <span style="font-size:18px">${c.icon}</span>
      <span class="cat-name-text">${c.name}</span>
      <button class="cat-del" onclick="confirmDeleteCat('${c.id}')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
      </button>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ MODAL: ADD/EDIT OP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let editingOpId  = null;
let selectedType = 'expense';
let selectedCat  = null;

window.openAddOpModal = function(opId=null, prefillCat=null){
  editingOpId = opId; selectedType = 'expense'; selectedCat = prefillCat;
  if(opId){
    const op = operations.find(o=>o.id===opId);
    if(op){
      selectedType = op.type; selectedCat = op.category;
      document.getElementById('op-amount').value = fmtVND(op.amount);
      document.getElementById('op-comment').value = op.comment||'';
      document.getElementById('op-date').value = op.date;
      document.getElementById('op-date-group').style.display='block';
      document.getElementById('op-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
      document.getElementById('op-del-btn').style.display='block';
    }
  } else {
    document.getElementById('op-amount').value = '';
    document.getElementById('op-comment').value = '';
    document.getElementById('op-date').value = dateStr();
    document.getElementById('op-date-group').style.display='none';
    document.getElementById('op-modal-title').textContent = '–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è';
    document.getElementById('op-del-btn').style.display='none';
    renderSuggestions(0);
  }
  updateTypeButtons(); updateCatsPicker();
  openModal('overlay-op');
};
window.openEditOpModal = window.openAddOpModal;

window.selectType = function(t){ selectedType=t; updateTypeButtons(); updateCatsPicker(); };
function updateTypeButtons(){
  document.getElementById('type-expense').className='type-btn expense'+(selectedType==='expense'?' active':'');
  document.getElementById('type-income').className='type-btn income'+(selectedType==='income'?' active':'');
}
function updateCatsPicker(){
  const visible = categories.filter(c=>!c.type||c.type===selectedType);
  if(selectedCat && !visible.find(c=>c.id===selectedCat)) selectedCat=null;
  const cp = document.getElementById('cats-picker');
  if(!cp) return;
  cp.innerHTML = visible.map(c=>`
    <div class="cat-pick ${c.id===selectedCat?'selected':''}" onclick="selectCat('${c.id}')">
      <span class="dot" style="background:${c.color}"></span>${c.icon} ${c.name}
    </div>`).join('');
}
window.selectCat = function(id){
  selectedCat=id;
  document.querySelectorAll('#cats-picker .cat-pick').forEach(el=>{
    const elId=el.getAttribute('onclick').match(/'([^']+)'/)?.[1];
    el.classList.toggle('selected', elId===id);
  });
};
window.saveOperation = function(){
  const amountRaw = parseVND(document.getElementById('op-amount').value);
  if(!amountRaw){ alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É'); return; }
  if(!selectedCat){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }
  if(editingOpId){
    const idx = operations.findIndex(o=>o.id===editingOpId);
    if(idx>-1) operations[idx] = {...operations[idx], amount:amountRaw, type:selectedType, category:selectedCat,
      comment:document.getElementById('op-comment').value.trim(), date:document.getElementById('op-date').value};
  } else {
    operations.push({ id:'op_'+Date.now(), amount:amountRaw, type:selectedType, category:selectedCat,
      comment:document.getElementById('op-comment').value.trim(), date:dateStr(), createdAt:new Date().toISOString() });
  }
  save('ops', operations);
  closeModal('overlay-op'); renderAll();
};
window.deleteCurrentOp = function(){
  if(!editingOpId) return;
  operations = operations.filter(o=>o.id!==editingOpId);
  save('ops', operations);
  closeModal('overlay-op'); renderAll();
};

// ‚îÄ‚îÄ‚îÄ MODAL: BUDGET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openBudgetModal = function(){
  document.getElementById('budget-input').value = weeklyBudget ? fmtVND(weeklyBudget) : '';
  openModal('overlay-budget');
};
window.saveBudget = function(){
  weeklyBudget = parseVND(document.getElementById('budget-input').value);
  save('budget', weeklyBudget);
  closeModal('overlay-budget'); renderSettings(); renderHome();
};

// ‚îÄ‚îÄ‚îÄ MODAL: WEEKDAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let selectedWeekday = weekStartDay;
window.openWeekdayModal = function(){
  selectedWeekday = weekStartDay;
  document.getElementById('weekday-picker').innerHTML = DAYS.map((d,i)=>
    `<button class="wd-btn ${i===selectedWeekday?'active':''}" onclick="selectWeekday(${i})">${d}</button>`).join('');
  openModal('overlay-weekday');
};
window.selectWeekday = function(i){
  selectedWeekday=i;
  document.querySelectorAll('.wd-btn').forEach((b,j)=>b.classList.toggle('active',j===i));
};
window.saveWeekday = function(){
  weekStartDay=selectedWeekday;
  save('weekStart', weekStartDay);
  closeModal('overlay-weekday'); renderSettings(); renderHome();
};

// ‚îÄ‚îÄ‚îÄ MODAL: ADD CAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let selectedColor = COLORS[0];
let selectedIcon  = ICONS[0];
let selectedCatType = 'expense';
let iconEditMode = false;

window.selectCatType = function(t){
  selectedCatType=t;
  document.getElementById('cat-type-expense').className='cat-type-btn expense'+(t==='expense'?' active':'');
  document.getElementById('cat-type-income').className='cat-type-btn income'+(t==='income'?' active':'');
};
window.openAddCatModal = function(){
  selectedColor=COLORS[0]; selectedIcon=ICONS[0]; selectedCatType='expense';
  document.getElementById('cat-name-input').value='';
  document.getElementById('cat-type-expense').className='cat-type-btn expense active';
  document.getElementById('cat-type-income').className='cat-type-btn income';
  document.getElementById('color-picker').innerHTML = COLORS.map((c,i)=>
    `<div class="color-opt ${i===0?'selected':''}" style="background:${c}" onclick="selectColor('${c}',this)"></div>`).join('');
  iconEditMode=false; renderIconPicker();
  openModal('overlay-cat');
};
function renderIconPicker(){
  document.getElementById('icon-picker').innerHTML = ICONS.map((ic,i)=>`
    <div class="emoji-wrap">
      <div class="cat-pick ${ic===selectedIcon?'selected':''}" onclick="selectIcon('${ic}',this)" style="font-size:18px;padding:6px 10px">${ic}</div>
      ${iconEditMode?`<span class="emoji-del-x" onclick="removeIconFromList('${ic}')">√ó</span>`:''}
    </div>`).join('')
    + `<div id="emoji-add-btn" class="cat-pick" onclick="addCustomEmoji()" style="font-size:18px;padding:6px 10px;color:var(--text3);border-style:dashed">+</div>`;
}
window.toggleIconEditMode = function(){
  iconEditMode=!iconEditMode;
  const btn=document.getElementById('icon-edit-toggle');
  btn.textContent=iconEditMode?'–ì–æ—Ç–æ–≤–æ':'–ò–∑–º–µ–Ω–∏—Ç—å';
  btn.style.color=iconEditMode?'var(--accent)':'var(--text3)';
  const row=document.getElementById('custom-emoji-row'); if(row)row.remove();
  renderIconPicker();
};
window.removeIconFromList = function(ic){
  const idx=ICONS.indexOf(ic); if(idx>-1)ICONS.splice(idx,1);
  if(selectedIcon===ic) selectedIcon=ICONS[0]||'';
  renderIconPicker();
};
window.selectColor = function(c,el){
  selectedColor=c;
  document.querySelectorAll('.color-opt').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
};
window.selectIcon = function(ic,el){
  selectedIcon=ic;
  document.querySelectorAll('#icon-picker .cat-pick').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
};
window.addCustomEmoji = function(){
  let existing=document.getElementById('custom-emoji-row');
  if(existing){ existing.querySelector('input').focus(); return; }
  const row=document.createElement('div');
  row.id='custom-emoji-row'; row.style='display:flex;gap:8px;margin-top:8px;align-items:center';
  row.innerHTML=`<input id="custom-emoji-input" type="text" maxlength="4" placeholder="üéâ" class="form-input" style="width:80px;text-align:center;font-size:22px;padding:8px"/>
    <button onclick="confirmCustomEmoji()" class="btn btn-primary" style="flex:1;padding:10px;font-size:13px">–î–æ–±–∞–≤–∏—Ç—å</button>`;
  document.getElementById('icon-picker').after(row);
  row.querySelector('input').focus();
};
window.confirmCustomEmoji = function(){
  const val=document.getElementById('custom-emoji-input').value.trim();
  if(!val)return;
  const ic=[...val][0];
  if(!ICONS.includes(ic))ICONS.push(ic);
  selectedIcon=ic;
  const row=document.getElementById('custom-emoji-row'); if(row)row.remove();
  renderIconPicker();
};
window.saveCategory = function(){
  const name=document.getElementById('cat-name-input').value.trim();
  if(!name){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
  categories.push({id:'c_'+Date.now(),name,color:selectedColor,icon:selectedIcon,type:selectedCatType});
  save('cats', categories);
  closeModal('overlay-cat'); renderSettings(); renderHome();
};

// ‚îÄ‚îÄ‚îÄ CONFIRM DELETE CAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.confirmDeleteCat = function(catId){
  const cat=categories.find(c=>c.id===catId);
  const count=operations.filter(o=>o.category===catId).length;
  document.getElementById('confirm-title').textContent=`–£–¥–∞–ª–∏—Ç—å ¬´${cat.name}¬ª?`;
  document.getElementById('confirm-text').textContent=`–≠—Ç–æ —É–¥–∞–ª–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ ${count} –æ–ø–µ—Ä–∞—Ü–∏${count===1?'—é':count<5?'–∏':'–π'} –Ω–∞–≤—Å–µ–≥–¥–∞.`;
  document.getElementById('confirm-ok-btn').onclick=()=>{
    categories=categories.filter(c=>c.id!==catId);
    operations=operations.filter(o=>o.category!==catId);
    save('cats',categories); save('ops',operations);
    closeModal('overlay-confirm'); renderSettings(); renderHome();
  };
  openModal('overlay-confirm');
};

// ‚îÄ‚îÄ‚îÄ OVERLAY HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openModal  = function(id){ document.getElementById(id).classList.add('open'); };
window.closeModal = function(id){ document.getElementById(id).classList.remove('open'); };
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
window.closeOverlay = function(id,e){ if(e.target.id===id) closeModal(id); };

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ –¥–æ –≤—Ö–æ–¥–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ onAuthStateChanged
document.getElementById('app').style.display = 'none';

// –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ 00:00 –ø–æ –í—å–µ—Ç–Ω–∞–º—É
function scheduleMidnightRefresh(){
  const now = getVNNow();
  const ms = ((24-now.getHours())*3600 - now.getMinutes()*60 - now.getSeconds())*1000;
  setTimeout(()=>{ renderAll(); scheduleMidnightRefresh(); }, ms);
}
scheduleMidnightRefresh();
</script>
</body>
</html>
